<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ReadAloud">
<meta name="theme-color" content="#1A1A1E">
<title>ReadAloud ‚Äî Document & Web Page Reader</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
:root{--accent:#E85D2A;--accent-dark:#D4451A;--bg:#1A1A1E;--surface:#242428;--surface2:#2E2E34;--text:#E8E6E1;--text-dim:#9A9890;--border:#3A3A42}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}
body{padding-bottom:90px}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--surface)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.header{border-bottom:1px solid var(--border);padding:14px 18px;display:flex;align-items:center;gap:12px}
.header-icon{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.header h1{font-size:19px;font-weight:600;letter-spacing:-0.02em}
.header p{font-size:11px;color:var(--text-dim);font-family:'JetBrains Mono',monospace}
.header-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
.icon-btn{width:34px;height:34px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text-dim);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;position:relative}
.icon-btn:hover,.icon-btn.active{color:var(--accent);border-color:var(--accent)}
.icon-btn .badge{position:absolute;top:-4px;right:-4px;background:var(--accent);color:#fff;font-size:9px;font-family:'JetBrains Mono',monospace;width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center}
.container{max-width:900px;margin:0 auto;padding:18px 16px 100px}
.mode-toggle{display:flex;gap:0;background:var(--surface);border-radius:10px;padding:4px;width:fit-content;margin-bottom:16px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.mode-btn{padding:7px 14px;border-radius:8px;border:none;cursor:pointer;font-size:12px;font-family:'JetBrains Mono',monospace;font-weight:500;background:transparent;color:var(--text-dim);transition:all 0.2s;white-space:nowrap}
.mode-btn.active{background:var(--accent);color:#fff}
.clipboard-banner{padding:10px 14px;background:rgba(232,93,42,0.1);border:1px solid rgba(232,93,42,0.25);border-radius:10px;margin-bottom:14px;display:flex;align-items:center;gap:10px;font-size:13px;color:var(--text);font-family:'JetBrains Mono',monospace}
.clipboard-banner button{padding:6px 14px;border-radius:6px;border:none;background:var(--accent);color:#fff;font-size:12px;font-family:'JetBrains Mono',monospace;cursor:pointer;white-space:nowrap}
.clipboard-banner .dismiss{background:transparent;color:var(--text-dim);padding:6px 8px}
.url-row{display:flex;gap:8px;margin-bottom:10px}
.url-input-wrap{flex:1;position:relative}
.url-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--text-dim);pointer-events:none}
.url-input{width:100%;padding:12px 12px 12px 34px;background:var(--surface);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;font-family:'JetBrains Mono',monospace;outline:none;transition:border-color 0.2s}
.url-input:focus{border-color:var(--accent)}
.fetch-btn{padding:12px 18px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-size:13px;font-weight:600;font-family:'JetBrains Mono',monospace;cursor:pointer;white-space:nowrap;min-width:90px}
.fetch-btn:disabled{background:var(--surface2);color:var(--text-dim);cursor:default}
.tip-box{padding:10px 12px;background:var(--surface);border-radius:8px;border:1px solid var(--border);font-size:11px;color:var(--text-dim);font-family:'JetBrains Mono',monospace;line-height:1.7}
.tip-box strong{color:var(--text)}
.tip-link{color:var(--accent);cursor:pointer;text-decoration:underline}
.loaded-badge{margin-top:8px;padding:7px 12px;background:rgba(232,93,42,0.08);border-radius:8px;border:1px solid rgba(232,93,42,0.2);font-size:12px;color:var(--accent);font-family:'JetBrains Mono',monospace}
.loaded-badge strong{color:var(--text)}
.text-area{width:100%;min-height:160px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;color:var(--text);font-size:15px;font-family:'Crimson Pro',serif;line-height:1.7;resize:vertical;outline:none;transition:border-color 0.2s}
.text-area:focus{border-color:var(--accent)}
.text-meta{display:flex;justify-content:space-between;align-items:center;margin-top:7px;flex-wrap:wrap;gap:6px}
.text-meta span{font-size:11px;color:var(--text-dim);font-family:'JetBrains Mono',monospace}
.action-btn{padding:7px 18px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-size:13px;font-weight:600;font-family:'JetBrains Mono',monospace;cursor:pointer}
.action-btn:disabled{background:var(--surface2);color:var(--text-dim);cursor:default}
.action-btn.secondary{background:var(--surface2);color:var(--text)}
.action-btn.secondary:hover{background:var(--border)}
.file-label{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:120px;background:var(--surface);border:2px dashed var(--border);border-radius:12px;cursor:pointer;transition:border-color 0.2s}
.file-label:hover{border-color:var(--accent)}
.file-label .icon{font-size:28px;margin-bottom:6px}
.file-label .name{font-size:14px;color:var(--text-dim)}
.file-label .formats{font-size:11px;color:var(--text-dim);margin-top:3px;font-family:'JetBrains Mono',monospace}
.rss-row{display:flex;gap:8px;margin-bottom:10px}
.rss-articles{max-height:250px;overflow-y:auto}
.rss-item{padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:all 0.15s}
.rss-item:hover{border-color:var(--accent)}
.rss-item .rss-title{font-size:14px;font-weight:600;margin-bottom:3px}
.rss-item .rss-date{font-size:11px;color:var(--text-dim);font-family:'JetBrains Mono',monospace}
.error-box{padding:9px 12px;background:#3A1A1A;border:1px solid #6A2A2A;border-radius:8px;color:#FF8A80;font-size:12px;margin-bottom:12px}
.controls-panel{background:var(--surface);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--border)}
.controls-grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
.ctrl-label{font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.08em;font-family:'JetBrains Mono',monospace;display:block;margin-bottom:5px}
.voice-select{width:100%;padding:7px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;font-family:'JetBrains Mono',monospace;cursor:pointer;outline:none}
input[type="range"]{width:100%;accent-color:var(--accent);margin-top:3px}
.range-labels{display:flex;justify-content:space-between;font-size:9px;color:var(--text-dim);font-family:'JetBrains Mono',monospace}
.speed-presets{display:flex;gap:5px;margin-top:10px;flex-wrap:wrap}
.speed-btn{padding:3px 10px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-size:11px;font-family:'JetBrains Mono',monospace;cursor:pointer;transition:all 0.15s}
.speed-btn.active{border-color:var(--accent);background:rgba(232,93,42,0.13);color:var(--accent)}
.extra-controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center}
.extra-controls label{font-size:11px;color:var(--text-dim);font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:5px}
.extra-controls select{padding:4px 6px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:11px;font-family:'JetBrains Mono',monospace;outline:none}
.sleep-indicator{padding:3px 10px;border-radius:12px;background:rgba(232,93,42,0.15);color:var(--accent);font-size:11px;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:5px}
.sleep-indicator .cancel{cursor:pointer;font-size:13px;opacity:0.7}
.sleep-indicator .cancel:hover{opacity:1}
.text-size-row{display:flex;gap:5px;align-items:center}
.ts-btn{width:26px;height:26px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text-dim);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace}
.ts-btn:hover{border-color:var(--accent);color:var(--accent)}
.ts-label{font-size:11px;color:var(--text-dim);font-family:'JetBrains Mono',monospace;min-width:30px;text-align:center}
.reading-area{background:var(--surface);border-radius:12px;border:1px solid var(--border);margin-bottom:16px;overflow:hidden}
.progress-bar{height:3px;background:var(--surface2)}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),#FF8A50);transition:width 0.3s ease;border-radius:2px}
.reading-header{padding:10px 18px 0;display:flex;justify-content:space-between;align-items:center}
.reading-title{font-size:12px;color:var(--accent);font-family:'JetBrains Mono',monospace}
.time-remaining{font-size:11px;color:var(--text-dim);font-family:'JetBrains Mono',monospace}
.reading-content{padding:18px;max-height:380px;overflow-y:auto;line-height:1.9}
.sentence{cursor:pointer;padding:2px 4px;border-radius:4px;transition:all 0.15s;border-bottom:2px solid transparent}
.sentence:hover{background:var(--surface2)}
.sentence.active{background:rgba(232,93,42,0.2);color:#fff;border-bottom-color:var(--accent)}
.sentence.past{color:var(--text-dim)}
.reading-footer{border-top:1px solid var(--border);padding:8px 18px;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--text-dim);font-family:'JetBrains Mono',monospace;flex-wrap:wrap;gap:6px}
.bookmark-btn{padding:3px 10px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-size:11px;font-family:'JetBrains Mono',monospace;cursor:pointer}
.bookmark-btn:hover{border-color:var(--accent);color:var(--accent)}
.queue-panel{background:var(--surface);border-radius:12px;border:1px solid var(--border);margin-bottom:16px;overflow:hidden}
.queue-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-family:'JetBrains Mono',monospace}
.queue-header span{font-size:13px;font-weight:600}
.queue-list{max-height:250px;overflow-y:auto}
.queue-item{padding:10px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);transition:background 0.15s;cursor:pointer}
.queue-item:last-child{border-bottom:none}
.queue-item:hover{background:var(--surface2)}
.queue-item.active-item{background:rgba(232,93,42,0.1)}
.queue-item .qi-info{flex:1;min-width:0}
.queue-item .qi-title{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.queue-item .qi-meta{font-size:10px;color:var(--text-dim);font-family:'JetBrains Mono',monospace}
.queue-item .qi-remove{width:24px;height:24px;border-radius:6px;border:none;background:transparent;color:var(--text-dim);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.queue-item .qi-remove:hover{color:#FF8A80;background:#3A1A1A}
.queue-empty{padding:20px;text-align:center;color:var(--text-dim);font-size:13px;font-family:'JetBrains Mono',monospace}
.cleanup-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.cleanup-tag{padding:3px 10px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-size:11px;font-family:'JetBrains Mono',monospace;cursor:pointer;transition:all 0.15s}
.cleanup-tag.active{border-color:var(--accent);color:var(--accent);background:rgba(232,93,42,0.1)}
.playback-bar{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;justify-content:center;gap:8px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:100;padding-bottom:max(10px,env(safe-area-inset-bottom))}
.pb-btn{width:38px;height:38px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.pb-btn:disabled{color:var(--text-dim);cursor:default}
.pb-btn.para-skip{font-size:10px;font-family:'JetBrains Mono',monospace;font-weight:700}
.pb-play{width:50px;height:50px;border-radius:25px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(232,93,42,0.27)}
.pb-play:disabled{background:var(--surface2);box-shadow:none;cursor:default}
.pb-status{margin-left:10px;font-size:11px;color:var(--text-dim);font-family:'JetBrains Mono',monospace;min-width:60px;text-align:center}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:420px;width:100%}
.modal h3{font-size:18px;margin-bottom:10px;text-align:center}
.modal p{font-size:13px;color:var(--text-dim);font-family:'JetBrains Mono',monospace;margin-bottom:14px;text-align:center}
.export-progress{height:6px;background:var(--surface2);border-radius:3px;margin-bottom:12px;overflow:hidden}
.export-progress-fill{height:100%;background:var(--accent);transition:width 0.2s;border-radius:3px}
.shortcut-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border)}
.shortcut-row:last-child{border-bottom:none}
.shortcut-row span{font-size:13px;color:var(--text-dim)}
.shortcut-key{padding:3px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;font-size:12px;font-family:'JetBrains Mono',monospace;color:var(--text)}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite;vertical-align:middle;margin-right:5px}
@keyframes spin{to{transform:rotate(360deg)}}
.section{margin-bottom:16px}
.hidden{display:none!important}
@media(max-width:600px){.controls-grid{grid-template-columns:1fr 1fr}.pb-status{display:none}.reading-content{padding:14px}.pb-btn.para-skip{display:none}}
</style>
</head>
<body>
<div class="header">
  <div class="header-icon">üîä</div>
  <div><h1>ReadAloud</h1><p>Document & Web Page Reader</p></div>
  <div class="header-actions">
    <button class="icon-btn" id="btn-queue-toggle" title="Queue">üìã<span class="badge hidden" id="queue-badge">0</span></button>
    <button class="icon-btn" id="btn-export" title="Export Audio">üíæ</button>
    <button class="icon-btn" id="btn-shortcuts" title="Keyboard Shortcuts">‚å®Ô∏è</button>
  </div>
</div>
<div class="container">
  <div class="clipboard-banner hidden" id="clipboard-banner">
    <span style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" id="clipboard-preview">üìã Text detected on clipboard</span>
    <button id="clipboard-load">Load</button>
    <button class="dismiss" id="clipboard-dismiss">‚úï</button>
  </div>
  <div class="mode-toggle">
    <button class="mode-btn active" data-mode="text">‚úèÔ∏è Paste</button>
    <button class="mode-btn" data-mode="url">üåê URL</button>
    <button class="mode-btn" data-mode="file">üìÑ File</button>
    <button class="mode-btn" data-mode="rss">üì° RSS</button>
  </div>
  <div id="url-section" class="section hidden">
    <div class="url-row"><div class="url-input-wrap"><span class="url-icon">üîó</span><input type="text" class="url-input" id="url-input" placeholder="https://example.com/article"></div><button class="fetch-btn" id="fetch-btn">Fetch ‚Üí</button></div>
    <div style="display:flex;gap:6px;margin-bottom:8px"><button class="action-btn secondary" id="url-add-queue" style="font-size:11px;padding:5px 12px">+ Add to Queue</button></div>
    <div class="tip-box">üí° <strong>Tips:</strong> Works best with articles &amp; blogs. Paywalled or JS-heavy sites may not work ‚Äî use <span class="tip-link" id="tip-paste-link">Paste</span> as fallback.</div>
    <div class="loaded-badge hidden" id="loaded-badge">‚úì Loaded: <strong id="loaded-title"></strong></div>
  </div>
  <div id="text-section" class="section">
    <textarea class="text-area" id="text-area" placeholder="Paste any text, article content, or web page text here..."></textarea>
    <div class="text-meta"><span id="word-count">0 words</span><div style="display:flex;gap:6px"><button class="action-btn secondary" id="text-add-queue" style="font-size:11px;padding:5px 12px">+ Queue</button><button class="action-btn" id="load-btn" disabled>Load Text ‚Üí</button></div></div>
    <div class="cleanup-row" id="cleanup-row">
      <span style="font-size:10px;color:var(--text-dim);font-family:'JetBrains Mono',monospace;line-height:26px">Clean:</span>
      <button class="cleanup-tag active" data-clean="ads">Ads/Subscribe</button>
      <button class="cleanup-tag active" data-clean="share">Share prompts</button>
      <button class="cleanup-tag" data-clean="links">URLs</button>
      <button class="cleanup-tag" data-clean="brackets">Brackets [...]</button>
    </div>
  </div>
  <div id="file-section" class="section hidden">
    <label class="file-label"><input type="file" accept=".txt,.md,.html,.csv,.docx" id="file-input" style="display:none"><div class="icon">üìÑ</div><span class="name" id="file-name">Tap to choose a file</span><span class="formats">.docx ¬∑ .txt ¬∑ .md ¬∑ .html ¬∑ .csv</span></label>
  </div>
  <div id="rss-section" class="section hidden">
    <div class="rss-row"><div class="url-input-wrap"><span class="url-icon">üì°</span><input type="text" class="url-input" id="rss-input" placeholder="https://example.com/feed.xml"></div><button class="fetch-btn" id="rss-fetch-btn">Load Feed ‚Üí</button></div>
    <div class="rss-articles hidden" id="rss-articles"></div>
    <div class="tip-box" style="margin-top:8px">üí° Paste an RSS or Atom feed URL. Try adding <code style="color:var(--accent)">/feed</code> or <code style="color:var(--accent)">/rss</code> to any blog URL.</div>
  </div>
  <div class="error-box hidden" id="error-box"></div>
  <div class="queue-panel hidden" id="queue-panel">
    <div class="queue-header"><span>üìã Read Queue</span><button class="action-btn secondary" id="queue-clear" style="font-size:10px;padding:3px 10px">Clear All</button></div>
    <div class="queue-list" id="queue-list"><div class="queue-empty">Queue is empty ‚Äî add items from any input tab</div></div>
  </div>
  <div class="controls-panel">
    <div class="controls-grid">
      <div><label class="ctrl-label">Voice</label><select class="voice-select" id="voice-select"></select></div>
      <div><label class="ctrl-label" id="speed-label">Speed: 1x</label><input type="range" id="speed-range" min="0.5" max="2.5" step="0.1" value="1"><div class="range-labels"><span>0.5x</span><span>2.5x</span></div></div>
      <div><label class="ctrl-label" id="pitch-label">Pitch: 1</label><input type="range" id="pitch-range" min="0.5" max="1.5" step="0.1" value="1"><div class="range-labels"><span>Low</span><span>High</span></div></div>
      <div><label class="ctrl-label" id="vol-label">Volume: 100%</label><input type="range" id="vol-range" min="0" max="1" step="0.05" value="1"><div class="range-labels"><span>0</span><span>100%</span></div></div>
    </div>
    <div class="speed-presets" id="speed-presets">
      <button class="speed-btn" data-speed="0.9">0.9x</button><button class="speed-btn active" data-speed="1">1x</button><button class="speed-btn" data-speed="1.1">1.1x</button><button class="speed-btn" data-speed="1.2">1.2x</button><button class="speed-btn" data-speed="1.25">1.25x</button>
    </div>
    <div class="extra-controls">
      <label>üò¥ Sleep:<select id="sleep-select"><option value="0">Off</option><option value="5">5 min</option><option value="15">15 min</option><option value="30">30 min</option><option value="60">60 min</option></select></label>
      <div class="sleep-indicator hidden" id="sleep-indicator">üåô <span id="sleep-countdown"></span><span class="cancel" id="sleep-cancel">‚úï</span></div>
      <div style="margin-left:auto" class="text-size-row"><button class="ts-btn" id="ts-down">A-</button><span class="ts-label" id="ts-label">17</span><button class="ts-btn" id="ts-up">A+</button></div>
    </div>
  </div>
  <div class="reading-area hidden" id="reading-area">
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    <div class="reading-header"><div class="reading-title hidden" id="reading-title"></div><div class="time-remaining hidden" id="time-remaining"></div></div>
    <div class="reading-content" id="reading-content" style="font-size:17px"></div>
    <div class="reading-footer"><span id="sentence-counter">0 / 0 sentences</span><div style="display:flex;gap:6px;align-items:center"><button class="bookmark-btn" id="bookmark-btn">üîñ Bookmark</button><span>Tap to jump</span></div></div>
  </div>
  <div class="loaded-badge hidden" id="bookmark-restore" style="cursor:pointer;margin-bottom:14px">üîñ Saved position: sentence <strong id="bookmark-pos"></strong> ‚Äî tap to resume</div>
</div>
<div class="playback-bar">
  <button class="pb-btn" id="btn-stop" title="Stop">‚èπ</button>
  <button class="pb-btn para-skip" id="btn-para-prev" title="Prev paragraph">‚èÆ¬∂</button>
  <button class="pb-btn" id="btn-prev" title="Prev sentence" disabled>‚èÆ</button>
  <button class="pb-play" id="btn-play" disabled>‚ñ∂</button>
  <button class="pb-btn" id="btn-next" title="Next sentence" disabled>‚è≠</button>
  <button class="pb-btn para-skip" id="btn-para-next" title="Next paragraph">¬∂‚è≠</button>
  <div class="pb-status" id="pb-status">Ready ¬∑ 1x</div>
</div>
<div class="modal-overlay hidden" id="export-overlay"><div class="modal"><h3>Export Audio</h3><p id="export-status">Generating audio‚Ä¶</p><div class="export-progress"><div class="export-progress-fill" id="export-progress-fill" style="width:0%"></div></div><div style="display:flex;gap:8px;justify-content:center"><button class="action-btn secondary" id="export-cancel">Cancel</button><a class="action-btn hidden" id="export-download" download="readaloud-export.webm" style="text-decoration:none;text-align:center">Download</a></div></div></div>
<div class="modal-overlay hidden" id="shortcuts-overlay"><div class="modal"><h3>‚å®Ô∏è Keyboard Shortcuts</h3><div class="shortcut-row"><span>Play / Pause</span><span class="shortcut-key">Space</span></div><div class="shortcut-row"><span>Stop</span><span class="shortcut-key">Esc</span></div><div class="shortcut-row"><span>Previous sentence</span><span class="shortcut-key">‚Üê</span></div><div class="shortcut-row"><span>Next sentence</span><span class="shortcut-key">‚Üí</span></div><div class="shortcut-row"><span>Previous paragraph</span><span class="shortcut-key">Shift+‚Üê</span></div><div class="shortcut-row"><span>Next paragraph</span><span class="shortcut-key">Shift+‚Üí</span></div><div class="shortcut-row"><span>Speed down</span><span class="shortcut-key">-</span></div><div class="shortcut-row"><span>Speed up</span><span class="shortcut-key">+</span></div><div class="shortcut-row"><span>Bookmark</span><span class="shortcut-key">B</span></div><div style="margin-top:14px;text-align:center"><button class="action-btn" id="shortcuts-close">Close</button></div></div></div>
<script>
// STATE
let inputMode='text',rawText='',sentences=[],paragraphStarts=[],currentIndex=-1,isPlaying=false,isPaused=false;
let rate=1,pitch=1,volume=1,selectedVoice='',fetchedTitle='',textFontSize=17;
let queue=[],queueIndex=-1,sleepTimer=null,sleepEnd=0,sleepInterval=null;
let bookmarkKey='',clipboardText='',exportCancel=false;
let cleanupFlags={ads:true,share:true,links:false,brackets:false};
const synth=window.speechSynthesis;let voices=[];
const $=id=>document.getElementById(id);
const modeBtns=document.querySelectorAll('.mode-btn');

function showError(m){$('error-box').textContent=m;$('error-box').classList.remove('hidden')}
function hideError(){$('error-box').classList.add('hidden')}
function extractTextFromHTML(html){const p=new DOMParser(),d=p.parseFromString(html,'text/html');d.querySelectorAll('script,style,nav,footer,header,aside,iframe,noscript,svg,form,button,input,[role="navigation"],[role="banner"],[role="contentinfo"],.nav,.menu,.sidebar,.footer,.header,.ad,.advertisement,.cookie').forEach(e=>e.remove());const m=d.querySelector('article,main,[role="main"],.post-content,.article-body,.entry-content,.content');let t=((m||d.body)?.innerText||(m||d.body)?.textContent||'');return t.replace(/\n{3,}/g,'\n\n').replace(/[ \t]+/g,' ').trim()}
function cleanText(t){if(cleanupFlags.ads) t=t.replace(/\b(advertisement|sponsored|subscribe now|sign up for|newsletter|click here to|download our app|cookie policy|accept cookies|read more at|continue reading|related articles?:?)\b/gi,'');if(cleanupFlags.share) t=t.replace(/\b(share on|share via|tweet this|pin it|follow us|like us on|join our)\b[^.!?\n]*/gi,'');if(cleanupFlags.links) t=t.replace(/https?:\/\/\S+/g,'');if(cleanupFlags.brackets) t=t.replace(/\[[^\]]*\]/g,'');return t.replace(/\n{3,}/g,'\n\n').replace(/[ \t]+/g,' ').trim()}
function hashStr(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return Math.abs(h).toString(36)}

function parseText(text){rawText=text;if(!text.trim()){sentences=[];paragraphStarts=[];renderReading();return}const paras=text.split(/\n\s*\n/).filter(p=>p.trim());sentences=[];paragraphStarts=[];paras.forEach(para=>{paragraphStarts.push(sentences.length);const sents=para.split(/(?<=[.!?])\s+/).map(s=>s.trim()).filter(s=>s.length>0);if(sents.length===0&&para.trim()) sents.push(para.trim());sentences.push(...sents)});currentIndex=-1;$('progress-fill').style.width='0%';bookmarkKey='ra_bm_'+hashStr(text.substring(0,200));renderReading();updatePlayBtn();checkBookmark()}

function renderReading(){if(sentences.length===0){$('reading-area').classList.add('hidden');$('btn-prev').disabled=true;$('btn-next').disabled=true;return}$('reading-area').classList.remove('hidden');$('btn-prev').disabled=false;$('btn-next').disabled=false;if(fetchedTitle){$('reading-title').textContent='üìñ '+fetchedTitle;$('reading-title').classList.remove('hidden')}else $('reading-title').classList.add('hidden');updateTimeRemaining();$('reading-content').innerHTML='';$('reading-content').style.fontSize=textFontSize+'px';sentences.forEach((s,i)=>{if(i>0&&paragraphStarts.includes(i)){const br=document.createElement('div');br.style.height='12px';$('reading-content').appendChild(br)}const sp=document.createElement('span');sp.className='sentence'+(i===currentIndex?' active':'')+(i<currentIndex?' past':'');sp.textContent=s+' ';sp.addEventListener('click',()=>handleSentenceClick(i));$('reading-content').appendChild(sp)});sentenceCounterUpdate()}

function updateHighlight(){const spans=$('reading-content').querySelectorAll('.sentence');spans.forEach((sp,i)=>{sp.className='sentence'+(i===currentIndex?' active':'')+(i<currentIndex?' past':'');if(i===currentIndex) sp.scrollIntoView({behavior:'smooth',block:'center'})});sentenceCounterUpdate();$('progress-fill').style.width=Math.round(((currentIndex+1)/sentences.length)*100)+'%';updateTimeRemaining()}
function sentenceCounterUpdate(){$('sentence-counter').textContent=(currentIndex>=0?currentIndex+1:0)+' / '+sentences.length+' sentences'}
function updateTimeRemaining(){if(sentences.length===0||currentIndex<0){$('time-remaining').classList.add('hidden');return}const w=sentences.slice(currentIndex).join(' ').split(/\s+/).length;$('time-remaining').textContent='~'+Math.ceil(w/(150*rate))+' min left';$('time-remaining').classList.remove('hidden')}
function updatePlayBtn(){$('btn-play').disabled=sentences.length===0&&!rawText.trim();$('btn-play').textContent=isPlaying?'‚è∏':'‚ñ∂';$('pb-status').textContent=(isPlaying?'Playing':isPaused?'Paused':'Ready')+' ¬∑ '+rate+'x'}

// SPEECH
function speakFrom(index){if(index>=sentences.length){isPlaying=false;isPaused=false;currentIndex=-1;$('progress-fill').style.width='100%';updatePlayBtn();updateHighlight();if(queueIndex>=0&&queueIndex<queue.length-1) playQueueItem(queueIndex+1);return}synth.cancel();const utt=new SpeechSynthesisUtterance(sentences[index]);utt.rate=rate;utt.pitch=pitch;utt.volume=volume;const v=voices.find(v=>v.name===selectedVoice);if(v) utt.voice=v;utt.onstart=()=>{currentIndex=index;updateHighlight();updatePlayBtn()};utt.onend=()=>speakFrom(index+1);utt.onerror=e=>{if(e.error!=='canceled'){showError('Speech error: '+e.error);isPlaying=false;updatePlayBtn()}};synth.speak(utt)}
function handlePlay(){if(sentences.length===0&&rawText.trim()) parseText(cleanText(rawText));if(sentences.length===0) return;if(isPaused){synth.resume();isPaused=false;isPlaying=true;updatePlayBtn();return}isPlaying=true;isPaused=false;updatePlayBtn();speakFrom(currentIndex>=0?currentIndex:0)}
function handlePause(){synth.pause();isPaused=true;isPlaying=false;updatePlayBtn()}
function handleStop(){synth.cancel();isPlaying=false;isPaused=false;currentIndex=-1;$('progress-fill').style.width='0%';updatePlayBtn();updateHighlight()}
function handleSkipBack(){const n=Math.max(0,(currentIndex>=0?currentIndex:0)-1);if(isPlaying||isPaused){synth.cancel();isPaused=false;isPlaying=true;updatePlayBtn();speakFrom(n)}else{currentIndex=n;updateHighlight()}}
function handleSkipForward(){const n=Math.min(sentences.length-1,(currentIndex>=0?currentIndex:0)+1);if(isPlaying||isPaused){synth.cancel();isPaused=false;isPlaying=true;updatePlayBtn();speakFrom(n)}else{currentIndex=n;updateHighlight()}}
function handleParaBack(){const ci=currentIndex>=0?currentIndex:0;let t=0;for(let i=paragraphStarts.length-1;i>=0;i--){if(paragraphStarts[i]<ci){t=paragraphStarts[i];break}}if(isPlaying||isPaused){synth.cancel();isPaused=false;isPlaying=true;updatePlayBtn();speakFrom(t)}else{currentIndex=t;updateHighlight()}}
function handleParaForward(){const ci=currentIndex>=0?currentIndex:0;let t=sentences.length-1;for(let i=0;i<paragraphStarts.length;i++){if(paragraphStarts[i]>ci){t=paragraphStarts[i];break}}if(isPlaying||isPaused){synth.cancel();isPaused=false;isPlaying=true;updatePlayBtn();speakFrom(t)}else{currentIndex=t;updateHighlight()}}
function handleSentenceClick(i){if(isPlaying||isPaused){synth.cancel();isPaused=false;isPlaying=true;updatePlayBtn();speakFrom(i)}else{currentIndex=i;updateHighlight()}}

// VOICES
function loadVoices(){const all=synth.getVoices();const en=all.filter(v=>v.lang.startsWith('en'));voices=en.length>0?en:all;$('voice-select').innerHTML='';voices.forEach(v=>{const o=document.createElement('option');o.value=v.name;o.textContent=v.name.replace(/^(Microsoft |Google |Apple )/,'');$('voice-select').appendChild(o)});if(voices.length&&!selectedVoice){const s=voices.find(v=>v.name.toLowerCase().includes('samantha'));const p=voices.find(v=>v.name.includes('Natural')||v.name.includes('Enhanced')||v.name.includes('Google'));selectedVoice=(s||p||voices[0]).name;$('voice-select').value=selectedVoice}}
loadVoices();speechSynthesis.onvoiceschanged=loadVoices;

// MODE
function switchMode(m){inputMode=m;hideError();modeBtns.forEach(b=>b.classList.toggle('active',b.dataset.mode===m));['text','url','file','rss'].forEach(x=>$(x+'-section').classList.toggle('hidden',x!==m))}
modeBtns.forEach(b=>b.addEventListener('click',()=>switchMode(b.dataset.mode)));
$('tip-paste-link').addEventListener('click',()=>switchMode('text'));

// URL
async function fetchUrl(u){if(!/^https?:\/\//i.test(u)) u='https://'+u;const px=['https://api.allorigins.win/raw?url='+encodeURIComponent(u),'https://corsproxy.io/?'+encodeURIComponent(u)];let h=null;for(const p of px){try{const r=await fetch(p,{signal:AbortSignal.timeout(12000)});if(r.ok){h=await r.text();break}}catch(e){}}if(!h){try{const r=await fetch(u,{signal:AbortSignal.timeout(8000)});if(r.ok) h=await r.text()}catch(e){}}return h}
async function handleFetchUrl(){const raw=$('url-input').value.trim();if(!raw) return;hideError();fetchedTitle='';$('loaded-badge').classList.add('hidden');$('fetch-btn').innerHTML='<span class="spinner"></span>‚Ä¶';$('fetch-btn').disabled=true;const html=await fetchUrl(raw);$('fetch-btn').innerHTML='Fetch ‚Üí';$('fetch-btn').disabled=false;if(!html){showError("Couldn't fetch URL.");return}const tm=html.match(/<title[^>]*>(.*?)<\/title>/is);if(tm){fetchedTitle=tm[1].replace(/&[^;]+;/g,' ').trim();$('loaded-title').textContent=fetchedTitle;$('loaded-badge').classList.remove('hidden')}const text=extractTextFromHTML(html);if(!text||text.length<20){showError("Couldn't extract text.");return}parseText(cleanText(text))}
$('fetch-btn').addEventListener('click',handleFetchUrl);
$('url-input').addEventListener('keydown',e=>{if(e.key==='Enter') handleFetchUrl()});
$('url-add-queue').addEventListener('click',()=>{const u=$('url-input').value.trim();if(!u) return;addToQueue({title:u.replace(/^https?:\/\//,'').substring(0,60),text:null,url:u,type:'url'})});

// TEXT
$('text-area').addEventListener('input',()=>{hideError();rawText=$('text-area').value;const wc=rawText.trim()?rawText.trim().split(/\s+/).length:0;$('word-count').textContent=wc>0?wc+' words ¬∑ ~'+Math.ceil(wc/(150*rate))+' min':'0 words';$('load-btn').disabled=!rawText.trim()});
$('load-btn').addEventListener('click',()=>{fetchedTitle='';parseText(cleanText($('text-area').value))});
$('text-add-queue').addEventListener('click',()=>{const t=$('text-area').value.trim();if(!t) return;addToQueue({title:t.substring(0,60).replace(/\n/g,' ')+'‚Ä¶',text:t,type:'text'})});
document.querySelectorAll('.cleanup-tag').forEach(b=>b.addEventListener('click',()=>{cleanupFlags[b.dataset.clean]=!cleanupFlags[b.dataset.clean];b.classList.toggle('active',cleanupFlags[b.dataset.clean])}));

// FILE
$('file-input').addEventListener('change',async e=>{const f=e.target.files[0];if(!f) return;hideError();fetchedTitle='';$('file-name').textContent=f.name;try{if(f.name.endsWith('.docx')||f.type==='application/vnd.openxmlformats-officedocument.wordprocessingml.document'){const ab=await f.arrayBuffer();const r=await mammoth.extractRawText({arrayBuffer:ab});const t=r.value.replace(/\n{3,}/g,'\n\n').trim();if(!t){showError('No text in Word doc.');return}fetchedTitle=f.name;parseText(cleanText(t))}else if(f.type==='text/plain'||f.name.endsWith('.txt')||f.name.endsWith('.md')){fetchedTitle=f.name;parseText(cleanText(await f.text()))}else if(f.type==='text/html'||f.name.endsWith('.html')){fetchedTitle=f.name;parseText(cleanText(extractTextFromHTML(await f.text())))}else if(f.name.endsWith('.csv')){fetchedTitle=f.name;parseText(cleanText(await f.text()))}else showError('Supported: .docx, .txt, .md, .html, .csv')}catch(err){showError('Error: '+err.message)}});

// RSS
async function handleRssFetch(){const url=$('rss-input').value.trim();if(!url) return;hideError();$('rss-fetch-btn').innerHTML='<span class="spinner"></span>‚Ä¶';$('rss-fetch-btn').disabled=true;const xml=await fetchUrl(url);$('rss-fetch-btn').innerHTML='Load Feed ‚Üí';$('rss-fetch-btn').disabled=false;if(!xml){showError("Couldn't fetch feed.");return}const doc=new DOMParser().parseFromString(xml,'text/xml');const items=doc.querySelectorAll('item, entry');if(!items.length){showError('No articles found.');return}const arts=$('rss-articles');arts.innerHTML='';arts.classList.remove('hidden');items.forEach((item,i)=>{if(i>=20) return;const title=item.querySelector('title')?.textContent||'Untitled';const link=item.querySelector('link')?.textContent||item.querySelector('link')?.getAttribute('href')||'';const date=item.querySelector('pubDate, published, updated')?.textContent||'';const content=item.querySelector('description, content, summary')?.textContent||'';const div=document.createElement('div');div.className='rss-item';div.innerHTML='<div class="rss-title">'+title+'</div><div class="rss-date">'+(date?new Date(date).toLocaleDateString():'')+' ¬∑ <span style="color:var(--accent)">tap to load</span></div>';div.addEventListener('click',async()=>{hideError();fetchedTitle=title;let t='';if(content) t=extractTextFromHTML(content);if((!t||t.length<50)&&link){const h=await fetchUrl(link);if(h) t=extractTextFromHTML(h)}if(t&&t.length>=20) parseText(cleanText(t));else showError("Couldn't extract article.")});arts.appendChild(div)})}
$('rss-fetch-btn').addEventListener('click',handleRssFetch);
$('rss-input').addEventListener('keydown',e=>{if(e.key==='Enter') handleRssFetch()});

// QUEUE
function addToQueue(item){queue.push(item);renderQueue();$('queue-panel').classList.remove('hidden')}
function renderQueue(){const b=$('queue-badge');if(queue.length>0){b.textContent=queue.length;b.classList.remove('hidden')}else b.classList.add('hidden');const l=$('queue-list');if(!queue.length){l.innerHTML='<div class="queue-empty">Queue is empty</div>';return}l.innerHTML='';queue.forEach((item,i)=>{const d=document.createElement('div');d.className='queue-item'+(i===queueIndex?' active-item':'');d.innerHTML='<div style="font-size:14px;color:var(--text-dim)">'+(i+1)+'</div><div class="qi-info"><div class="qi-title">'+item.title+'</div><div class="qi-meta">'+item.type+'</div></div><button class="qi-remove" data-i="'+i+'">‚úï</button>';d.querySelector('.qi-info').addEventListener('click',()=>playQueueItem(i));d.querySelector('.qi-remove').addEventListener('click',e=>{e.stopPropagation();queue.splice(i,1);if(queueIndex>=i) queueIndex--;renderQueue()});l.appendChild(d)})}
async function playQueueItem(i){queueIndex=i;const item=queue[i];renderQueue();if(item.type==='url'&&!item.text){const h=await fetchUrl(item.url);if(h){item.text=extractTextFromHTML(h);const tm=h.match(/<title[^>]*>(.*?)<\/title>/is);if(tm) item.title=tm[1].replace(/&[^;]+;/g,' ').trim();renderQueue()}}if(item.text){fetchedTitle=item.title;parseText(cleanText(item.text));handlePlay()}else showError("Couldn't load queue item.")}
$('btn-queue-toggle').addEventListener('click',()=>$('queue-panel').classList.toggle('hidden'));
$('queue-clear').addEventListener('click',()=>{queue=[];queueIndex=-1;renderQueue()});

// CONTROLS
$('voice-select').addEventListener('change',()=>{selectedVoice=$('voice-select').value});
$('speed-range').addEventListener('input',()=>{rate=parseFloat($('speed-range').value);$('speed-label').textContent='Speed: '+rate+'x';document.querySelectorAll('.speed-btn').forEach(b=>b.classList.toggle('active',parseFloat(b.dataset.speed)===rate));updatePlayBtn()});
$('pitch-range').addEventListener('input',()=>{pitch=parseFloat($('pitch-range').value);$('pitch-label').textContent='Pitch: '+pitch});
$('vol-range').addEventListener('input',()=>{volume=parseFloat($('vol-range').value);$('vol-label').textContent='Volume: '+Math.round(volume*100)+'%'});
$('speed-presets').addEventListener('click',e=>{if(!e.target.classList.contains('speed-btn')) return;rate=parseFloat(e.target.dataset.speed);$('speed-range').value=rate;$('speed-label').textContent='Speed: '+rate+'x';document.querySelectorAll('.speed-btn').forEach(b=>b.classList.toggle('active',parseFloat(b.dataset.speed)===rate));updatePlayBtn()});
$('ts-up').addEventListener('click',()=>{if(textFontSize<28){textFontSize++;$('ts-label').textContent=textFontSize;$('reading-content').style.fontSize=textFontSize+'px'}});
$('ts-down').addEventListener('click',()=>{if(textFontSize>12){textFontSize--;$('ts-label').textContent=textFontSize;$('reading-content').style.fontSize=textFontSize+'px'}});

// SLEEP
$('sleep-select').addEventListener('change',()=>{const m=parseInt($('sleep-select').value);clearTimeout(sleepTimer);clearInterval(sleepInterval);if(m===0){$('sleep-indicator').classList.add('hidden');return}sleepEnd=Date.now()+m*60000;$('sleep-indicator').classList.remove('hidden');function upd(){const left=Math.max(0,sleepEnd-Date.now());if(left<=0){handleStop();$('sleep-indicator').classList.add('hidden');clearInterval(sleepInterval);$('sleep-select').value='0';return}$('sleep-countdown').textContent=Math.floor(left/60000)+':'+Math.floor((left%60000)/1000).toString().padStart(2,'0')}upd();sleepInterval=setInterval(upd,1000);sleepTimer=setTimeout(()=>{handleStop();$('sleep-indicator').classList.add('hidden');$('sleep-select').value='0'},m*60000)});
$('sleep-cancel').addEventListener('click',()=>{clearTimeout(sleepTimer);clearInterval(sleepInterval);$('sleep-indicator').classList.add('hidden');$('sleep-select').value='0'});

// BOOKMARKS
$('bookmark-btn').addEventListener('click',()=>{if(currentIndex>=0&&bookmarkKey){try{localStorage.setItem(bookmarkKey,currentIndex.toString())}catch(e){}$('bookmark-btn').textContent='üîñ Saved!';setTimeout(()=>$('bookmark-btn').textContent='üîñ Bookmark',1500)}});
function checkBookmark(){try{const s=localStorage.getItem(bookmarkKey);if(s!==null&&parseInt(s)<sentences.length){$('bookmark-pos').textContent=parseInt(s)+1;$('bookmark-restore').classList.remove('hidden')}else $('bookmark-restore').classList.add('hidden')}catch(e){$('bookmark-restore').classList.add('hidden')}}
$('bookmark-restore').addEventListener('click',()=>{try{const s=parseInt(localStorage.getItem(bookmarkKey));if(!isNaN(s)){currentIndex=s;updateHighlight();$('bookmark-restore').classList.add('hidden')}}catch(e){}});

// CLIPBOARD
async function checkClipboard(){try{if(!navigator.clipboard?.readText) return;const t=await navigator.clipboard.readText();if(t&&t.trim().length>50&&t!==clipboardText){clipboardText=t;$('clipboard-preview').textContent='üìã '+t.substring(0,80).replace(/\n/g,' ')+'‚Ä¶';$('clipboard-banner').classList.remove('hidden')}}catch(e){}}
$('clipboard-load').addEventListener('click',()=>{if(clipboardText){$('text-area').value=clipboardText;rawText=clipboardText;$('text-area').dispatchEvent(new Event('input'));$('clipboard-banner').classList.add('hidden');switchMode('text')}});
$('clipboard-dismiss').addEventListener('click',()=>$('clipboard-banner').classList.add('hidden'));
document.addEventListener('visibilitychange',()=>{if(!document.hidden) checkClipboard()});
window.addEventListener('focus',checkClipboard);setTimeout(checkClipboard,1000);

// EXPORT
$('btn-export').addEventListener('click',async()=>{if(!sentences.length){showError('Load text first.');return}exportCancel=false;$('export-overlay').classList.remove('hidden');$('export-download').classList.add('hidden');$('export-progress-fill').style.width='0%';$('export-status').textContent='Generating audio‚Ä¶';try{const ac=new AudioContext();const dest=ac.createMediaStreamDestination();const rec=new MediaRecorder(dest.stream,{mimeType:MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/webm'});const chunks=[];rec.ondataavailable=e=>{if(e.data.size>0) chunks.push(e.data)};rec.start();for(let i=0;i<sentences.length;i++){if(exportCancel){rec.stop();ac.close();return}$('export-progress-fill').style.width=Math.round((i/sentences.length)*100)+'%';$('export-status').textContent='Recording '+( i+1)+'/'+sentences.length+'‚Ä¶';await new Promise((res,rej)=>{const u=new SpeechSynthesisUtterance(sentences[i]);u.rate=rate;u.pitch=pitch;u.volume=volume;const v=voices.find(v=>v.name===selectedVoice);if(v) u.voice=v;u.onend=res;u.onerror=e=>e.error==='canceled'?rej('canceled'):res();synth.speak(u)})}rec.stop();await new Promise(r=>{rec.onstop=r});ac.close();const blob=new Blob(chunks,{type:'audio/webm'});$('export-download').href=URL.createObjectURL(blob);$('export-download').classList.remove('hidden');$('export-progress-fill').style.width='100%';$('export-status').textContent='‚úÖ Ready! Note: audio is best-effort via browser TTS.'}catch(e){if(e!=='canceled') $('export-status').textContent='Failed: '+(e.message||e)}});
$('export-cancel').addEventListener('click',()=>{exportCancel=true;synth.cancel();$('export-overlay').classList.add('hidden')});
$('export-overlay').addEventListener('click',e=>{if(e.target===$('export-overlay')){exportCancel=true;synth.cancel();$('export-overlay').classList.add('hidden')}});

// SHORTCUTS
$('btn-shortcuts').addEventListener('click',()=>$('shortcuts-overlay').classList.remove('hidden'));
$('shortcuts-close').addEventListener('click',()=>$('shortcuts-overlay').classList.add('hidden'));
$('shortcuts-overlay').addEventListener('click',e=>{if(e.target===$('shortcuts-overlay')) $('shortcuts-overlay').classList.add('hidden')});
document.addEventListener('keydown',e=>{if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT') return;if(e.code==='Space'){e.preventDefault();isPlaying?handlePause():handlePlay()}else if(e.code==='Escape'){handleStop();$('shortcuts-overlay').classList.add('hidden');$('export-overlay').classList.add('hidden')}else if(e.code==='ArrowLeft'&&e.shiftKey) handleParaBack();else if(e.code==='ArrowRight'&&e.shiftKey) handleParaForward();else if(e.code==='ArrowLeft') handleSkipBack();else if(e.code==='ArrowRight') handleSkipForward();else if(e.code==='Minus'||e.code==='NumpadSubtract'){rate=Math.max(0.5,Math.round((rate-0.1)*10)/10);$('speed-range').value=rate;$('speed-label').textContent='Speed: '+rate+'x';document.querySelectorAll('.speed-btn').forEach(b=>b.classList.toggle('active',parseFloat(b.dataset.speed)===rate));updatePlayBtn()}else if(e.code==='Equal'||e.code==='NumpadAdd'){rate=Math.min(2.5,Math.round((rate+0.1)*10)/10);$('speed-range').value=rate;$('speed-label').textContent='Speed: '+rate+'x';document.querySelectorAll('.speed-btn').forEach(b=>b.classList.toggle('active',parseFloat(b.dataset.speed)===rate));updatePlayBtn()}else if(e.code==='KeyB'&&!e.metaKey&&!e.ctrlKey) $('bookmark-btn').click()});

// PLAYBACK BAR
$('btn-play').addEventListener('click',()=>{isPlaying?handlePause():handlePlay()});
$('btn-stop').addEventListener('click',handleStop);
$('btn-prev').addEventListener('click',handleSkipBack);
$('btn-next').addEventListener('click',handleSkipForward);
$('btn-para-prev').addEventListener('click',handleParaBack);
$('btn-para-next').addEventListener('click',handleParaForward);

// iOS KEEP-ALIVE
let keepAlive;document.addEventListener('visibilitychange',()=>{if(document.hidden){clearInterval(keepAlive);keepAlive=setInterval(()=>{if(isPlaying&&synth.speaking) synth.resume()},10000)}else clearInterval(keepAlive)});

// SW
if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
</script>
</body>
</html>
