<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ReadAloud">
<meta name="theme-color" content="#1A1A1E">
<title>ReadAloud ‚Äî Document & Web Page Reader</title>
<link rel="manifest" href="manifest.json">
<!-- Apple Touch Icon (inline SVG data URI) -->
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj48cmVjdCB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgcng9IjQwIiBmaWxsPSIjRTg1RDJBIi8+PHRleHQgeD0iOTAiIHk9IjEyMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSI5MCIgZmlsbD0id2hpdGUiPvCflIo8L3RleHQ+PC9zdmc+">
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
  :root {
    --accent: #E85D2A;
    --accent-dark: #D4451A;
    --bg: #1A1A1E;
    --surface: #242428;
    --surface2: #2E2E34;
    --text: #E8E6E1;
    --text-dim: #9A9890;
    --border: #3A3A42;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { 
    height: 100%; background: var(--bg); color: var(--text);
    font-family: 'Crimson Pro', Georgia, serif;
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
  }
  body { padding-bottom: 80px; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--surface); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Header */
  .header {
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    display: flex; align-items: center; gap: 14;
  }
  .header-icon {
    width: 38px; height: 38px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    display: flex; align-items: center; justify-content: center; font-size: 19;
    flex-shrink: 0;
  }
  .header h1 { font-size: 20px; font-weight: 600; letter-spacing: -0.02em; }
  .header p { font-size: 12px; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }

  .container { max-width: 900px; margin: 0 auto; padding: 20px 16px 100px; }

  /* Mode Toggle */
  .mode-toggle {
    display: flex; gap: 0; background: var(--surface);
    border-radius: 10px; padding: 4px; width: fit-content; margin-bottom: 18px;
    overflow-x: auto; -webkit-overflow-scrolling: touch;
  }
  .mode-btn {
    padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer;
    font-size: 13px; font-family: 'JetBrains Mono', monospace; font-weight: 500;
    background: transparent; color: var(--text-dim);
    transition: all 0.2s; white-space: nowrap;
  }
  .mode-btn.active { background: var(--accent); color: #fff; }

  /* URL Section */
  .url-row { display: flex; gap: 10px; margin-bottom: 12px; }
  .url-input-wrap { flex: 1; position: relative; }
  .url-icon {
    position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
    font-size: 14px; color: var(--text-dim); pointer-events: none;
  }
  .url-input {
    width: 100%; padding: 13px 14px 13px 38px;
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    color: var(--text); font-size: 15px; font-family: 'JetBrains Mono', monospace;
    outline: none; transition: border-color 0.2s;
  }
  .url-input:focus { border-color: var(--accent); }
  .fetch-btn {
    padding: 13px 20px; border-radius: 10px; border: none;
    background: var(--accent); color: #fff; font-size: 14px; font-weight: 600;
    font-family: 'JetBrains Mono', monospace; cursor: pointer;
    white-space: nowrap; min-width: 100px; transition: all 0.2s;
  }
  .fetch-btn:disabled { background: var(--surface2); color: var(--text-dim); cursor: default; }

  .tip-box {
    padding: 11px 14px; background: var(--surface); border-radius: 8px;
    border: 1px solid var(--border); font-size: 12px; color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace; line-height: 1.7;
  }
  .tip-box strong { color: var(--text); }
  .tip-link { color: var(--accent); cursor: pointer; text-decoration: underline; }

  .loaded-badge {
    margin-top: 10px; padding: 8px 14px;
    background: rgba(232,93,42,0.08); border-radius: 8px;
    border: 1px solid rgba(232,93,42,0.2);
    font-size: 13px; color: var(--accent);
    font-family: 'JetBrains Mono', monospace;
  }
  .loaded-badge strong { color: var(--text); }

  /* Textarea */
  .text-area {
    width: 100%; min-height: 170px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 12px; padding: 14px;
    color: var(--text); font-size: 15px; font-family: 'Crimson Pro', serif;
    line-height: 1.7; resize: vertical; outline: none;
    transition: border-color 0.2s;
  }
  .text-area:focus { border-color: var(--accent); }
  .text-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
  .text-meta span { font-size: 12px; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
  .load-btn {
    padding: 8px 22px; border-radius: 8px; border: none;
    background: var(--accent); color: #fff; font-size: 14px; font-weight: 600;
    font-family: 'JetBrains Mono', monospace; cursor: pointer;
  }
  .load-btn:disabled { background: var(--surface2); color: var(--text-dim); cursor: default; }

  /* File Upload */
  .file-label {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 130px; background: var(--surface); border: 2px dashed var(--border);
    border-radius: 12px; cursor: pointer; transition: border-color 0.2s;
  }
  .file-label:hover { border-color: var(--accent); }
  .file-label .icon { font-size: 30px; margin-bottom: 8px; }
  .file-label .name { font-size: 15px; color: var(--text-dim); }
  .file-label .formats { font-size: 12px; color: var(--text-dim); margin-top: 4px; font-family: 'JetBrains Mono', monospace; }

  /* Error */
  .error-box {
    padding: 10px 14px; background: #3A1A1A; border: 1px solid #6A2A2A;
    border-radius: 8px; color: #FF8A80; font-size: 13px; margin-bottom: 14px;
  }

  /* Controls Panel */
  .controls-panel {
    background: var(--surface); border-radius: 12px; padding: 18px;
    margin-bottom: 18px; border: 1px solid var(--border);
  }
  .controls-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
  .ctrl-label {
    font-size: 11px; color: var(--text-dim); text-transform: uppercase;
    letter-spacing: 0.08em; font-family: 'JetBrains Mono', monospace;
    display: block; margin-bottom: 6px;
  }
  .voice-select {
    width: 100%; padding: 8px 10px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 6px; color: var(--text);
    font-size: 12px; font-family: 'JetBrains Mono', monospace; cursor: pointer; outline: none;
  }
  input[type="range"] { width: 100%; accent-color: var(--accent); margin-top: 4px; }
  .range-labels {
    display: flex; justify-content: space-between; font-size: 10px;
    color: var(--text-dim); font-family: 'JetBrains Mono', monospace;
  }
  .speed-presets { display: flex; gap: 6px; margin-top: 12px; flex-wrap: wrap; }
  .speed-btn {
    padding: 4px 12px; border-radius: 6px; border: 1px solid var(--border);
    background: transparent; color: var(--text-dim); font-size: 12px;
    font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 0.15s;
  }
  .speed-btn.active { border-color: var(--accent); background: rgba(232,93,42,0.13); color: var(--accent); }

  /* Reading Area */
  .reading-area {
    background: var(--surface); border-radius: 12px;
    border: 1px solid var(--border); margin-bottom: 18px; overflow: hidden;
  }
  .progress-bar { height: 3px; background: var(--surface2); }
  .progress-fill {
    height: 100%; background: linear-gradient(90deg, var(--accent), #FF8A50);
    transition: width 0.3s ease; border-radius: 2px;
  }
  .reading-title {
    padding: 12px 20px 0; font-size: 13px; color: var(--accent);
    font-family: 'JetBrains Mono', monospace;
  }
  .reading-content {
    padding: 20px; max-height: 380px; overflow-y: auto;
    line-height: 1.9; font-size: 17px;
  }
  .sentence {
    cursor: pointer; padding: 2px 4px; border-radius: 4px;
    transition: all 0.15s; border-bottom: 2px solid transparent;
  }
  .sentence:hover { background: var(--surface2); }
  .sentence.active {
    background: rgba(232,93,42,0.2); color: #fff;
    border-bottom-color: var(--accent);
  }
  .sentence.past { color: var(--text-dim); }
  .reading-footer {
    border-top: 1px solid var(--border); padding: 10px 20px;
    display: flex; justify-content: space-between; font-size: 12px;
    color: var(--text-dim); font-family: 'JetBrains Mono', monospace;
  }

  /* Playback Bar */
  .playback-bar {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: var(--surface); border-top: 1px solid var(--border);
    padding: 14px 20px; display: flex; align-items: center;
    justify-content: center; gap: 10px;
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    z-index: 100;
    padding-bottom: max(14px, env(safe-area-inset-bottom));
  }
  .pb-btn {
    width: 40px; height: 40px; border-radius: 8px;
    border: 1px solid var(--border); background: var(--surface2);
    color: var(--text); font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  .pb-btn:disabled { color: var(--text-dim); cursor: default; }
  .pb-play {
    width: 54px; height: 54px; border-radius: 27px; border: none;
    background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    color: #fff; font-size: 22px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 20px rgba(232,93,42,0.27);
  }
  .pb-play:disabled { background: var(--surface2); box-shadow: none; cursor: default; }
  .pb-status {
    margin-left: 14px; font-size: 12px; color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace; min-width: 70px; text-align: center;
  }

  .spinner {
    display: inline-block; width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
    border-radius: 50%; animation: spin 0.8s linear infinite;
    vertical-align: middle; margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .section { margin-bottom: 18px; }
  .hidden { display: none; }

  /* Responsive */
  @media (max-width: 600px) {
    .controls-grid { grid-template-columns: 1fr; }
    .header h1 { font-size: 18px; }
    .reading-content { font-size: 16px; padding: 16px; }
    .pb-status { display: none; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-icon">üîä</div>
  <div>
    <h1>ReadAloud</h1>
    <p>Document & Web Page Reader</p>
  </div>
</div>

<div class="container">
  <!-- Mode Toggle -->
  <div class="mode-toggle">
    <button class="mode-btn active" data-mode="text">‚úèÔ∏è Paste Text</button>
    <button class="mode-btn" data-mode="url">üåê Website URL</button>
    <button class="mode-btn" data-mode="file">üìÑ Upload File</button>
  </div>

  <!-- URL Input -->
  <div id="url-section" class="section hidden">
    <div class="url-row">
      <div class="url-input-wrap">
        <span class="url-icon">üîó</span>
        <input type="text" class="url-input" id="url-input" placeholder="https://example.com/article">
      </div>
      <button class="fetch-btn" id="fetch-btn">Fetch Page ‚Üí</button>
    </div>
    <div class="tip-box">
      üí° <strong>Tips:</strong> Works best with articles, blog posts, and static pages.
      Some sites (paywalled, login-required, or heavily JS-rendered) may not work ‚Äî use
      <span class="tip-link" id="tip-paste-link">Paste Text</span> as a fallback.
    </div>
    <div class="loaded-badge hidden" id="loaded-badge">‚úì Loaded: <strong id="loaded-title"></strong></div>
  </div>

  <!-- Text Input -->
  <div id="text-section" class="section">
    <textarea class="text-area" id="text-area" placeholder="Paste any text, article content, or web page text here..."></textarea>
    <div class="text-meta">
      <span id="word-count">0 words</span>
      <button class="load-btn" id="load-btn" disabled>Load Text ‚Üí</button>
    </div>
  </div>

  <!-- File Upload -->
  <div id="file-section" class="section hidden">
    <label class="file-label" id="file-label">
      <input type="file" accept=".txt,.md,.html,.csv,.docx" id="file-input" style="display:none">
      <div class="icon">üìÑ</div>
      <span class="name" id="file-name">Tap to choose a file</span>
      <span class="formats">.docx ¬∑ .txt ¬∑ .md ¬∑ .html ¬∑ .csv</span>
    </label>
  </div>

  <!-- Error -->
  <div class="error-box hidden" id="error-box"></div>

  <!-- Voice & Speed Controls -->
  <div class="controls-panel">
    <div class="controls-grid">
      <div>
        <label class="ctrl-label">Voice</label>
        <select class="voice-select" id="voice-select"></select>
      </div>
      <div>
        <label class="ctrl-label" id="speed-label">Speed: 1x</label>
        <input type="range" id="speed-range" min="0.5" max="2.5" step="0.1" value="1">
        <div class="range-labels"><span>0.5x</span><span>2.5x</span></div>
      </div>
      <div>
        <label class="ctrl-label" id="pitch-label">Pitch: 1</label>
        <input type="range" id="pitch-range" min="0.5" max="1.5" step="0.1" value="1">
        <div class="range-labels"><span>Low</span><span>High</span></div>
      </div>
    </div>
    <div class="speed-presets" id="speed-presets">
      <button class="speed-btn" data-speed="0.75">0.75x</button>
      <button class="speed-btn active" data-speed="1">1x</button>
      <button class="speed-btn" data-speed="1.25">1.25x</button>
      <button class="speed-btn" data-speed="1.5">1.5x</button>
      <button class="speed-btn" data-speed="2">2x</button>
    </div>
  </div>

  <!-- Reading Area -->
  <div class="reading-area hidden" id="reading-area">
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    <div class="reading-title hidden" id="reading-title"></div>
    <div class="reading-content" id="reading-content"></div>
    <div class="reading-footer">
      <span id="sentence-counter">0 / 0 sentences</span>
      <span>Tap any sentence to jump</span>
    </div>
  </div>
</div>

<!-- Playback Bar -->
<div class="playback-bar">
  <button class="pb-btn" id="btn-stop" title="Stop">‚èπ</button>
  <button class="pb-btn" id="btn-prev" title="Previous" disabled>‚èÆ</button>
  <button class="pb-play" id="btn-play" disabled>‚ñ∂</button>
  <button class="pb-btn" id="btn-next" title="Next" disabled>‚è≠</button>
  <div class="pb-status" id="pb-status">Ready ¬∑ 1x</div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let inputMode = 'text';
let rawText = '';
let sentences = [];
let currentIndex = -1;
let isPlaying = false;
let isPaused = false;
let rate = 1.0;
let pitch = 1.0;
let selectedVoice = '';
let fetchedTitle = '';
const synth = window.speechSynthesis;
let voices = [];

// ‚îÄ‚îÄ DOM Refs ‚îÄ‚îÄ
const $ = (id) => document.getElementById(id);
const modeBtns = document.querySelectorAll('.mode-btn');
const urlSection = $('url-section');
const textSection = $('text-section');
const fileSection = $('file-section');
const urlInput = $('url-input');
const fetchBtn = $('fetch-btn');
const loadedBadge = $('loaded-badge');
const loadedTitle = $('loaded-title');
const textArea = $('text-area');
const wordCountEl = $('word-count');
const loadBtn = $('load-btn');
const fileInput = $('file-input');
const fileNameEl = $('file-name');
const errorBox = $('error-box');
const voiceSelect = $('voice-select');
const speedRange = $('speed-range');
const speedLabel = $('speed-label');
const pitchRange = $('pitch-range');
const pitchLabel = $('pitch-label');
const speedPresets = $('speed-presets');
const readingArea = $('reading-area');
const readingTitle = $('reading-title');
const readingContent = $('reading-content');
const progressFill = $('progress-fill');
const sentenceCounter = $('sentence-counter');
const btnStop = $('btn-stop');
const btnPrev = $('btn-prev');
const btnPlay = $('btn-play');
const btnNext = $('btn-next');
const pbStatus = $('pb-status');

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function showError(msg) { errorBox.textContent = msg; errorBox.classList.remove('hidden'); }
function hideError() { errorBox.classList.add('hidden'); }

function extractTextFromHTML(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  doc.querySelectorAll('script,style,nav,footer,header,aside,iframe,noscript,svg,form,button,input,[role="navigation"],[role="banner"],[role="contentinfo"],.nav,.menu,.sidebar,.footer,.header,.ad,.advertisement,.cookie').forEach(el => el.remove());
  const main = doc.querySelector('article,main,[role="main"],.post-content,.article-body,.entry-content,.content');
  const src = main || doc.body;
  let text = (src?.innerText || src?.textContent || '');
  return text.replace(/\n{3,}/g, '\n\n').replace(/[ \t]+/g, ' ').trim();
}

function parseText(text) {
  rawText = text;
  if (!text.trim()) { sentences = []; renderReading(); return; }
  sentences = text.split(/(?<=[.!?])\s+|(?:\n\s*\n)/).map(s => s.trim()).filter(s => s.length > 0);
  currentIndex = -1;
  progressFill.style.width = '0%';
  renderReading();
  updatePlayBtn();
}

function renderReading() {
  if (sentences.length === 0) {
    readingArea.classList.add('hidden');
    btnPrev.disabled = true; btnNext.disabled = true;
    return;
  }
  readingArea.classList.remove('hidden');
  btnPrev.disabled = false; btnNext.disabled = false;

  if (fetchedTitle) {
    readingTitle.textContent = 'üìñ ' + fetchedTitle;
    readingTitle.classList.remove('hidden');
  } else {
    readingTitle.classList.add('hidden');
  }

  readingContent.innerHTML = '';
  sentences.forEach((s, i) => {
    const span = document.createElement('span');
    span.className = 'sentence' + (i === currentIndex ? ' active' : '') + (i < currentIndex ? ' past' : '');
    span.textContent = s + ' ';
    span.addEventListener('click', () => handleSentenceClick(i));
    readingContent.appendChild(span);
  });
  sentenceCounter.textContent = `${currentIndex >= 0 ? currentIndex + 1 : 0} / ${sentences.length} sentences`;
}

function updateHighlight() {
  const spans = readingContent.querySelectorAll('.sentence');
  spans.forEach((span, i) => {
    span.className = 'sentence' + (i === currentIndex ? ' active' : '') + (i < currentIndex ? ' past' : '');
    if (i === currentIndex) span.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });
  sentenceCounter.textContent = `${currentIndex >= 0 ? currentIndex + 1 : 0} / ${sentences.length} sentences`;
  progressFill.style.width = `${Math.round(((currentIndex + 1) / sentences.length) * 100)}%`;
}

function updatePlayBtn() {
  btnPlay.disabled = sentences.length === 0 && !rawText.trim();
  btnPlay.textContent = isPlaying ? '‚è∏' : '‚ñ∂';
  pbStatus.textContent = `${isPlaying ? 'Playing' : isPaused ? 'Paused' : 'Ready'} ¬∑ ${rate}x`;
}

// ‚îÄ‚îÄ Speech ‚îÄ‚îÄ
function speakFrom(index) {
  if (index >= sentences.length) {
    isPlaying = false; isPaused = false; currentIndex = -1;
    progressFill.style.width = '100%';
    updatePlayBtn(); updateHighlight();
    return;
  }
  synth.cancel();
  const utt = new SpeechSynthesisUtterance(sentences[index]);
  utt.rate = rate;
  utt.pitch = pitch;
  const v = voices.find(v => v.name === selectedVoice);
  if (v) utt.voice = v;
  utt.onstart = () => {
    currentIndex = index;
    updateHighlight();
    updatePlayBtn();
  };
  utt.onend = () => speakFrom(index + 1);
  utt.onerror = (e) => {
    if (e.error !== 'canceled') { showError('Speech error: ' + e.error); isPlaying = false; updatePlayBtn(); }
  };
  synth.speak(utt);
}

function handlePlay() {
  if (sentences.length === 0 && rawText.trim()) parseText(rawText);
  if (sentences.length === 0) return;
  if (isPaused) { synth.resume(); isPaused = false; isPlaying = true; updatePlayBtn(); return; }
  isPlaying = true; isPaused = false; updatePlayBtn();
  speakFrom(currentIndex >= 0 ? currentIndex : 0);
}
function handlePause() { synth.pause(); isPaused = true; isPlaying = false; updatePlayBtn(); }
function handleStop() {
  synth.cancel(); isPlaying = false; isPaused = false; currentIndex = -1;
  progressFill.style.width = '0%';
  updatePlayBtn(); updateHighlight();
}
function handleSkipBack() {
  const ni = Math.max(0, (currentIndex >= 0 ? currentIndex : 0) - 1);
  if (isPlaying || isPaused) { synth.cancel(); isPaused = false; isPlaying = true; updatePlayBtn(); speakFrom(ni); }
  else { currentIndex = ni; updateHighlight(); }
}
function handleSkipForward() {
  const ni = Math.min(sentences.length - 1, (currentIndex >= 0 ? currentIndex : 0) + 1);
  if (isPlaying || isPaused) { synth.cancel(); isPaused = false; isPlaying = true; updatePlayBtn(); speakFrom(ni); }
  else { currentIndex = ni; updateHighlight(); }
}
function handleSentenceClick(i) {
  if (isPlaying || isPaused) { synth.cancel(); isPaused = false; isPlaying = true; updatePlayBtn(); speakFrom(i); }
  else { currentIndex = i; updateHighlight(); }
}

// ‚îÄ‚îÄ Voices ‚îÄ‚îÄ
function loadVoices() {
  const all = synth.getVoices();
  const en = all.filter(v => v.lang.startsWith('en'));
  voices = en.length > 0 ? en : all;
  voiceSelect.innerHTML = '';
  voices.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = v.name.replace(/^(Microsoft |Google |Apple )/, '');
    voiceSelect.appendChild(opt);
  });
  if (voices.length && !selectedVoice) {
    const pref = voices.find(v => v.name.includes('Natural') || v.name.includes('Enhanced') || v.name.includes('Google'));
    selectedVoice = (pref || voices[0]).name;
    voiceSelect.value = selectedVoice;
  }
}
loadVoices();
speechSynthesis.onvoiceschanged = loadVoices;

// ‚îÄ‚îÄ Mode Toggle ‚îÄ‚îÄ
function switchMode(mode) {
  inputMode = mode; hideError();
  modeBtns.forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
  textSection.classList.toggle('hidden', mode !== 'text');
  urlSection.classList.toggle('hidden', mode !== 'url');
  fileSection.classList.toggle('hidden', mode !== 'file');
}
modeBtns.forEach(b => b.addEventListener('click', () => switchMode(b.dataset.mode)));
$('tip-paste-link').addEventListener('click', () => switchMode('text'));

// ‚îÄ‚îÄ URL Fetch ‚îÄ‚îÄ
async function handleFetchUrl() {
  const raw = urlInput.value.trim();
  if (!raw) return;
  hideError(); fetchedTitle = '';
  loadedBadge.classList.add('hidden');
  fetchBtn.innerHTML = '<span class="spinner"></span>Fetching‚Ä¶';
  fetchBtn.disabled = true;

  let targetUrl = raw;
  if (!/^https?:\/\//i.test(targetUrl)) targetUrl = 'https://' + targetUrl;

  const proxies = [
    `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`,
    `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`,
  ];

  let html = null;
  for (const proxy of proxies) {
    try {
      const res = await fetch(proxy, { signal: AbortSignal.timeout(12000) });
      if (res.ok) { html = await res.text(); break; }
    } catch (e) { continue; }
  }
  if (!html) {
    try { const res = await fetch(targetUrl, { signal: AbortSignal.timeout(8000) }); if (res.ok) html = await res.text(); } catch(e) {}
  }

  fetchBtn.innerHTML = 'Fetch Page ‚Üí'; fetchBtn.disabled = false;

  if (!html) { showError("Couldn't fetch that URL. The site may block automated access. Try copy-pasting instead."); return; }

  const titleMatch = html.match(/<title[^>]*>(.*?)<\/title>/is);
  if (titleMatch) {
    fetchedTitle = titleMatch[1].replace(/&[^;]+;/g, ' ').trim();
    loadedTitle.textContent = fetchedTitle;
    loadedBadge.classList.remove('hidden');
  }

  const text = extractTextFromHTML(html);
  if (!text || text.length < 20) { showError("Fetched the page but couldn't extract readable text. Try copy-pasting instead."); return; }

  parseText(text);
}
fetchBtn.addEventListener('click', handleFetchUrl);
urlInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleFetchUrl(); });

// ‚îÄ‚îÄ Text Input ‚îÄ‚îÄ
textArea.addEventListener('input', () => {
  hideError();
  rawText = textArea.value;
  const wc = rawText.trim() ? rawText.trim().split(/\s+/).length : 0;
  const est = Math.ceil(wc / (150 * rate));
  wordCountEl.textContent = wc > 0 ? `${wc} words ¬∑ ~${est} min at ${rate}x` : '0 words';
  loadBtn.disabled = !rawText.trim();
});
loadBtn.addEventListener('click', () => { fetchedTitle = ''; parseText(textArea.value); });

// ‚îÄ‚îÄ File Upload ‚îÄ‚îÄ
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  hideError(); fetchedTitle = '';
  fileNameEl.textContent = file.name;

  try {
    if (file.name.endsWith('.docx') || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer });
      const text = result.value.replace(/\n{3,}/g, '\n\n').trim();
      if (!text) { showError('Could not extract text from this Word document.'); return; }
      parseText(text);
    } else if (file.type === 'text/plain' || file.name.endsWith('.txt') || file.name.endsWith('.md')) {
      parseText(await file.text());
    } else if (file.type === 'text/html' || file.name.endsWith('.html')) {
      parseText(extractTextFromHTML(await file.text()));
    } else if (file.name.endsWith('.csv')) {
      parseText(await file.text());
    } else {
      showError('Supported formats: .docx, .txt, .md, .html, .csv');
    }
  } catch (err) {
    showError('Error reading file: ' + err.message);
  }
});

// ‚îÄ‚îÄ Controls ‚îÄ‚îÄ
voiceSelect.addEventListener('change', () => { selectedVoice = voiceSelect.value; });
speedRange.addEventListener('input', () => {
  rate = parseFloat(speedRange.value);
  speedLabel.textContent = `Speed: ${rate}x`;
  document.querySelectorAll('.speed-btn').forEach(b => b.classList.toggle('active', parseFloat(b.dataset.speed) === rate));
  updatePlayBtn();
});
pitchRange.addEventListener('input', () => {
  pitch = parseFloat(pitchRange.value);
  pitchLabel.textContent = `Pitch: ${pitch}`;
});
speedPresets.addEventListener('click', (e) => {
  if (!e.target.classList.contains('speed-btn')) return;
  rate = parseFloat(e.target.dataset.speed);
  speedRange.value = rate;
  speedLabel.textContent = `Speed: ${rate}x`;
  document.querySelectorAll('.speed-btn').forEach(b => b.classList.toggle('active', parseFloat(b.dataset.speed) === rate));
  updatePlayBtn();
});

// ‚îÄ‚îÄ Playback Bar ‚îÄ‚îÄ
btnPlay.addEventListener('click', () => { isPlaying ? handlePause() : handlePlay(); });
btnStop.addEventListener('click', handleStop);
btnPrev.addEventListener('click', handleSkipBack);
btnNext.addEventListener('click', handleSkipForward);

// ‚îÄ‚îÄ Keep iOS speech alive (iOS pauses synth after ~15s in background) ‚îÄ‚îÄ
let keepAlive;
function startKeepAlive() {
  clearInterval(keepAlive);
  keepAlive = setInterval(() => { if (isPlaying && synth.speaking) synth.resume(); }, 10000);
}
function stopKeepAlive() { clearInterval(keepAlive); }
document.addEventListener('visibilitychange', () => {
  if (document.hidden) startKeepAlive(); else stopKeepAlive();
});

// ‚îÄ‚îÄ Register Service Worker for PWA / offline ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>
